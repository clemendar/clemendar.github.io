<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Plan</title>
</head>
<body>
  <div id="cal">
    <div class='week week-0'></div>
  </div>
<style type="text/css">
* {
  font-family: monospace;
  box-sizing: border-box;
}
#cal {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  padding-top: 3vw;
  padding-bottom: 3vw;
}

.desc {
  font-size: 2vw;
  text-align: center;
  white-space: pre-wrap;
}

.week {
  display: flex;
  height: 13vw;
  width: 91vw;
}

.day {
  display: flex;
  width: 13vw;
  justify-content: center;
  align-items: center;
  font-size: 3vw;
  border: 1px solid white;
  flex-direction: column;
  user-select: none;
}
</style>
<script type="module">

// Setup
const DAY = 1000*60*60*24
const CAL = document.getElementById('cal')
const FIRST = new Date('01/01/2022')

const selected = Object.fromEntries(
  [...new URLSearchParams(location.search).keys()]
    .map(s => [s, true])
)

console.log(selected)

const holidays = {
  '1_1': "New Year's Day",
  '15_4': "Good Friday",
  '17_4': "Easter Sunday",
  '25_4': "Freedom Day",
  '01_5': "Labour Day",
  '10_6': "Portugal Day",
  '16_6': "Corpus Christi",
  '15_8': "Assumption of Mary",
  '5_10': "Republic Day in Portugal",
  '1_11': "All Saints' Day",
  '1_12': "Portugal Independence Day",
  '8_12': "Feast of the Immaculate Conception",
  '25_12': "Christmas Day",
}

const specials = {
  '21_1': 'ðŸ›¬\nback to lisboa',
  '5_3': 'ðŸŽ‚\nClement',
  '3_11': 'ðŸŽ‚\nAline',
}

let [currentWeek] = document.getElementsByClassName('week')
// Start a Saturday
let week = 0
for (const dayIndex of [...Array(365).keys()]) {
  const day = new Date(FIRST.getTime() + dayIndex * DAY)
  const m = day.getMonth()
  const hue = (m * 30 + ( m % 2 ? 180 : 0)) % 360
  const tag = `${day.getDate()}_${day.getMonth()+1}`
  const elem = document.createElement('div')
  if (day.getDay() === 1) {
    const weekElem = document.createElement('div')
    weekElem.classList.add('week', `week-${++week}`)
    currentWeek = weekElem
    CAL.append(weekElem)
  }
  elem.classList.add('day', `day-${day.getDay()}`, tag)
  const offDay = holidays[tag] || (dayIndex +3)% 6 > 3
  const description = specials[tag] || holidays[tag]
  if (description) {
    const desc = document.createElement('div')
    desc.classList.add('desc')
    desc.textContent = description
    elem.append(desc)
  } else {
    elem.textContent = day.getDate()
  }

  if (offDay || selected[tag]) {
    elem.style.backgroundColor = `hsl(${hue},100%,85%)`
    elem.style.borderColor = `hsl(${hue},100%,96%)`
  } else {
    elem.style.backgroundColor = `hsl(${hue},100%,96%)`
  }
  elem.style.color = `hsl(${hue},100%,30%)`

  offDay || (
    elem.onclick = () => {
      console.log(tag)
      if ((selected[tag] = !selected[tag])) {
        if (Object.entries(selected).filter(e => e[1]).length >= 14) {
          selected[tag] = false
          return
        }
        elem.style.backgroundColor = `hsl(${hue},100%,85%)`
        elem.style.border = `1vw solid hsl(${hue},100%,96%)`
      } else {
        elem.style.backgroundColor = `hsl(${hue},100%,96%)`
        elem.style.border = ''
      }
      console.log(Object.entries(selected).filter(e => e[1]).map(e => e[0]))
      const selection = Object.entries(selected).filter(e => e[1]).map(e => e[0]).join('&')
      history.replaceState('', null, `?${selection}`)
    }
  )
  currentWeek.append(elem)
}


// Updates
const update = () => {


}

// update tick every seconds
setInterval(() => requestAnimationFrame(update), 60000)

</script>
</body>
</html>
